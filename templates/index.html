<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture</title>
</head>
<body>
   <!-- <label for="selfie" class="capture-button">Front Camera</label>
    <input type="file" id="selfie" capture="user" accept="image/*"> -->
        
    <label for="photo" class="capture-button">Back Camera</label>
    <input type="file" id="photo" capture="environment" accept="image/*">
    <script>
        (function() {
            document.getElementById("photo").onchange = function(){
            var files = document.getElementById("photo").files;
            var file = files[0];
            if(!file){
                return alert("No file selected.");
            }
            getSignedRequest(file);
        };
    })();

    function getSignedRequest(file){
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                if(xhr.status === 200){
                    var response = JSON.parse(xhr.responseText);
                    uploadFile(file, response.data, response.url);
                }
                else{
                    console.log("xml request status code...")
                    console.log(xhr.status)
                    alert("Could not get signed URL.");
                }
            }
        };
        xhr.send();
    }

    function uploadFile(file, s3Data, url){
        var xhr = new XMLHttpRequest();
        xhr.open("POST", s3Data.url);

        var postData = new FormData();
        for(key in s3Data.fields){
            postData.append(key, s3Data.fields[key]);
        }
        postData.append('file', file);

        xhr.onreadystatechange = function() {
            if(xhr.readyState === 4){
                if(xhr.status === 200 || xhr.status === 204){
                    document.getElementById("preview").src = url;
                    document.getElementById("avatar-url").value = url;
                }
                else{
                    alert("Could not upload file.");
                }
            }
        };
        xhr.send(postData);
    }
    </script>   
 
</body>
</html>