<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture</title>

    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/style.css') }}">

</head>
<body>

    <form method="post" enctype="multipart/form-data">
        <div class="image_form">
            <div class="file_container"> 
                <!-- <label for="photo" class="capture-button">Back Camera</label> -->
                <label for="photo" class="capture-button">
                    <img src="../static/css/camera-white.jpeg" id="photo-camera" alt="Back Camera" width="50" height="50"/>
                </label>

                <input type="file" id="photo" capture="environment" accept="image/*">
            </div>
            <div class="preview">
                <p>No files currently selected for upload</p>
            </div>
            <div>
                <button id="submit-btn">Submit</button>
            </div>
        </div>
    </form>

    <script>
        const input = document.querySelector("input");
        const preview = document.querySelector(".preview");

        input.style.opacity = 0;

        input.addEventListener("change", updateImageDisplay);

        function updateImageDisplay() {
            while (preview.firstChild) {
                preview.removeChild(preview.firstChild);
            }

            const curFiles = input.files;
            if (curFiles.length === 0) {
                const para = document.createElement("p");
                para.textContent = "No files currently selected for upload";
                preview.appendChild(para);
            } 
            else {
                const list = document.createElement("ol");
                preview.appendChild(list);

                for (const file of curFiles) {
                    const listItem = document.createElement("li");
                    const para = document.createElement("p");
                    if (validFileType(file)) {
                        const image = document.createElement("img");
                        image.setAttribute("id", "img_2_upload");
                        image.src = URL.createObjectURL(file);
                        image.alt = image.title = file.name;

                    listItem.appendChild(image);
                    }

                list.appendChild(listItem);
                }
            }
            const button = document.querySelector("form button");

            button.style.visibility = "visible";
        }

        // https://developer.mozilla.org/en-US/docs/Web/Media/Formats/Image_types
        const fileTypes = [
        "image/apng",
        "image/bmp",
        "image/gif",
        "image/jpeg",
        "image/pjpeg",
        "image/png",
        "image/svg+xml",
        "image/tiff",
        "image/webp",
        "image/x-icon",
        ];

        function validFileType(file) {
            return fileTypes.includes(file.type);
        }

        function returnFileSize(number) {
            if (number < 1024) {
                return `${number} bytes`;
            }
            else if (number >= 1024 && number < 1048576) {
                return `${(number / 1024).toFixed(1)} KB`;
            }
            else if (number >= 1048576) {
                return `${(number / 1048576).toFixed(1)} MB`;
            }
        }

        const button = document.querySelector("form button");

        button.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("attempting to blur image")
            var img = document.getElementById('img_2_upload');
            img.style.filter = 'blur(5px)';
            // const para = document.createElement("p");
            // para.append("Image uploaded!");
            // preview.replaceChildren(para);
        });


    //     (function() {
    //         document.getElementById("photo").onchange = function(){
    //         var files = document.getElementById("photo").files;
    //         var file = files[0];
    //         if(!file){
    //             return alert("No file selected.");
    //         }
    //         getSignedRequest(file);
    //     };
    // })();

    // function getSignedRequest(file){
    //     var xhr = new XMLHttpRequest();
    //     xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
    //     xhr.onreadystatechange = function(){
    //         if(xhr.readyState === 4){
    //             if(xhr.status === 200){
    //                 var response = JSON.parse(xhr.responseText);
    //                 console.log(`file: ${file} , response data ${response.data} , response url ${response.url}`)
    //                 uploadFile(file, response.data, response.url);
    //             }
    //             else{
    //                 console.log("xml request status code...")
    //                 console.log(xhr.status)
    //                 alert("Could not get signed URL.");
    //             }
    //         }
    //     };
    //     xhr.send();
    // }

    // function uploadFile(file, s3Data, url){
    //     var xhr = new XMLHttpRequest();
    //     xhr.open("POST", s3Data.url);

    //     var postData = new FormData();
    //     for(key in s3Data.fields){
    //         postData.append(key, s3Data.fields[key]);
    //     }
    //     postData.append('file', file);

    //     xhr.onreadystatechange = function() {
    //         if(xhr.readyState === 4){
    //             if(xhr.status === 200 || xhr.status === 204){
    //                 console.log("xhr status 200")
    //             }
    //             else{
    //                 alert("Could not upload file.");
    //             }
    //         }
    //     };
    //     xhr.send(postData);
    // }
    </script>   
 
</body>
</html>